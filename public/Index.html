<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MotoGP Quiz Race</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .animate-pulse { animation: pulse 1.5s infinite; }
    .player-bike {
      transition: left 0.7s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: left;
    }
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      transform: scale(1.15);
    }
    .track-finish {
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 100%);
    }
    .ready-badge {
      animation: pulse 2s infinite;
    }
    @media print {
    body * {
        visibility: hidden;
    }
    #finalScores, #finalScores * {
        visibility: visible;
    }
    #finalScores {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    }
  </style>
</head>
<body class="bg-gray-900 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    
    <!-- Lobby Screen -->
    <div id="lobby" class="bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
      <div class="bg-red-600 py-4 px-6 text-center">
        <h1 class="text-3xl font-bold text-white">üèç MotoGP Quiz Race</h1>
        <p class="text-red-100">Race dengan menjawab pertanyaan!</p>
      </div>
      
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-gray-300 mb-2">Nama Pembalap:</label>
          <input id="playerName" type="text" placeholder="Masukkan nama kamu" 
                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-white">
        </div>
        
        <div class="mb-6">
          <label class="block text-gray-300 mb-3">Warna Motor:</label>
          <div class="flex gap-3">
            <div class="color-option bg-red-500 selected" data-color="#ef4444" title="Merah"></div>
            <div class="color-option bg-blue-500" data-color="#3b82f6" title="Biru"></div>
            <div class="color-option bg-yellow-400" data-color="#facc15" title="Kuning"></div>
            <div class="color-option bg-green-500" data-color="#22c55e" title="Hijau"></div>
            <div class="color-option bg-purple-500" data-color="#a855f7" title="Ungu"></div>
          </div>
        </div>
        
        <button id="joinBtn" 
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105">
          Gabung Balapan
        </button>
      </div>

      <!-- Lobby Players List -->
      <div id="lobbyPlayers" class="p-6 pt-0 space-y-2 max-h-60 overflow-y-auto">
        <!-- Players will appear here -->
      </div>

      <!-- Ready Section -->
      <div id="readySection" class="hidden p-6 pt-0">
        <div class="text-center mb-4">
          <p class="text-gray-300">Menunggu pemain lain siap...</p>
          <p id="readyStatus" class="text-sm text-gray-400">
            Siap: <span id="readyCount">0</span> / <span id="totalPlayers">0</span> pemain
          </p>
          <p class="text-xs text-gray-500">Maksimal 50 pemain</p>
        </div>
        <div class="flex gap-3">
          <button id="readyBtn" 
                  class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all">
            Siap Balap
          </button>
          <button id="notReadyBtn" 
                  class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-all">
            Tidak Siap
          </button>
        </div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden mt-6 space-y-6">
      
      <!-- Race Track -->
      <div class="bg-gray-800 rounded-xl p-4">
        <div class="relative h-20 bg-gray-700 rounded-full overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-r from-gray-700 via-gray-600 to-gray-700"></div>
          <div id="playersTrack" class="relative h-full">
            <!-- Players will appear here -->
          </div>
          <div class="absolute right-0 top-0 h-full w-4 track-finish"></div>
        </div>
      </div>
      
      <!-- Question Panel -->
      <div id="questionPanel" class="bg-gray-800 rounded-xl p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <span id="questionCounter" class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">Q1/5</span>
          <div class="w-3/4 bg-gray-700 rounded-full h-2.5">
            <div id="timerBar" class="bg-red-600 h-2.5 rounded-full transition-all duration-1000" style="width: 100%"></div>
          </div>
          <span id="timeLeft" class="text-white font-bold">15s</span>
        </div>
        
        <h2 id="questionText" class="text-xl font-bold text-white mb-4"></h2>
        
        <div id="options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- Options will appear here -->
        </div>

        <div id="answerFeedback" class="hidden mt-4 p-4 rounded-lg text-center">
          <!-- Answer feedback will appear here -->
        </div>
      </div>
      
      <!-- Leaderboard -->
      <div id="leaderboard" class="bg-gray-800 rounded-xl p-6">
        <h3 class="text-lg font-bold text-white mb-3">üèÜ Leaderboard</h3>
        <div id="leaderboardList" class="space-y-2">
          <!-- Leaderboard will appear here -->
        </div>
      </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden mt-6">
        <div class="bg-gray-800 rounded-xl p-8 text-center">
        <h2 class="text-3xl font-bold text-white mb-4">üèÅ Game Selesai!</h2>
        <div id="winnerAnnouncement" class="mb-6">
        <!-- Winner announcement will appear here -->
        </div>
        <div id="finalScores" class="mb-6">
        <!-- Final scores will appear here -->
        </div>
        <div class="flex gap-4 justify-center">
        <button id="playAgainBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg">
            Main Lagi
        </button>
        <button id="downloadPdfBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
            Download Hasil
        </button>
        </div>
    </div>
    </div>

  <script>
    // Socket.io Connection
    const socket = io();
    let playerId;
    let currentQuestion;
    let questionStartTime;
    let timeLeft;
    let timerInterval;
    let selectedColor = '#ef4444';
    let isReady = false;
    let hasAnswered = false;

    // DOM Elements
    const lobbyEl = document.getElementById('lobby');
    const gameScreenEl = document.getElementById('gameScreen');
    const gameOverScreenEl = document.getElementById('gameOverScreen');
    const playersTrackEl = document.getElementById('playersTrack');
    const questionTextEl = document.getElementById('questionText');
    const optionsEl = document.getElementById('options');
    const timerBarEl = document.getElementById('timerBar');
    const timeLeftEl = document.getElementById('timeLeft');
    const leaderboardListEl = document.getElementById('leaderboardList');
    const questionCounterEl = document.getElementById('questionCounter');
    const joinBtn = document.getElementById('joinBtn');
    const readyBtn = document.getElementById('readyBtn');
    const notReadyBtn = document.getElementById('notReadyBtn');
    const readySection = document.getElementById('readySection');
    const lobbyPlayers = document.getElementById('lobbyPlayers');
    const readyCount = document.getElementById('readyCount');
    const totalPlayers = document.getElementById('totalPlayers');
    const answerFeedback = document.getElementById('answerFeedback');
    const winnerAnnouncement = document.getElementById('winnerAnnouncement');
    const finalScores = document.getElementById('finalScores');
    const playAgainBtn = document.getElementById('playAgainBtn');

    // Color Selection
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.color-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        this.classList.add('selected');
        selectedColor = this.dataset.color;
      });
    });

    // Join Game
    joinBtn.addEventListener('click', () => {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return alert('Masukkan nama pembalap!');
      
      joinBtn.textContent = 'Bergabung...';
      joinBtn.disabled = true;
      
      socket.emit('join', { 
        name: name,
        color: selectedColor
      }, (response) => {
        if (response.success) {
          readySection.classList.remove('hidden');
          joinBtn.style.display = 'none';
        } else {
          alert(response.message);
          joinBtn.textContent = 'Gabung Balapan';
          joinBtn.disabled = false;
        }
      });
    });

    // Ready Buttons
    readyBtn.addEventListener('click', () => {
      if (!isReady) {
        isReady = true;
        socket.emit('setReady', true);
        readyBtn.classList.add('bg-green-700', 'ready-badge');
        readyBtn.textContent = 'Siap! ‚úì';
        notReadyBtn.classList.remove('bg-gray-700');
        notReadyBtn.classList.add('bg-gray-600');
      }
    });

    notReadyBtn.addEventListener('click', () => {
      if (isReady) {
        isReady = false;
        socket.emit('setReady', false);
        readyBtn.classList.remove('bg-green-700', 'ready-badge');
        readyBtn.textContent = 'Siap Balap';
        notReadyBtn.classList.remove('bg-gray-600');
        notReadyBtn.classList.add('bg-gray-700');
      }
    });

    // Play Again Button
    playAgainBtn.addEventListener('click', () => {
      gameOverScreenEl.classList.add('hidden');
      lobbyEl.classList.remove('hidden');
      readySection.classList.remove('hidden');
      joinBtn.style.display = 'none';
      isReady = false;
      readyBtn.classList.remove('bg-green-700', 'ready-badge');
      readyBtn.textContent = 'Siap Balap';
    });

    // Socket Events
    socket.on('connect', () => {
      playerId = socket.id;
      console.log('Connected with ID:', playerId);
    });

    socket.on('lobbyUpdate', (data) => {
      console.log('Lobby update:', data);
      
      // Update players list
      lobbyPlayers.innerHTML = data.players.map(player => `
        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg ${player.isReady ? 'border-l-4 border-green-500' : ''}">
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full mr-3" style="background-color: ${player.color}"></div>
            <span class="text-white">${player.name}</span>
          </div>
          <span class="text-sm ${player.isReady ? 'text-green-400' : 'text-gray-400'}">
            ${player.isReady ? 'Siap ‚úì' : 'Menunggu...'}
          </span>
        </div>
      `).join('');

      // Update ready counter
      readyCount.textContent = data.readyCount;
      totalPlayers.textContent = data.totalPlayers;
    });

    socket.on('gameStarted', () => {
      console.log('Game started!');
      lobbyEl.classList.add('hidden');
      gameScreenEl.classList.remove('hidden');
      gameOverScreenEl.classList.add('hidden');
    });

    socket.on('newQuestion', (question) => {
      console.log('New question:', question);
      currentQuestion = question;
      questionStartTime = question.startTime;
      hasAnswered = false;
      
      // Hide answer feedback
      answerFeedback.classList.add('hidden');
      
      // Update UI
      questionTextEl.textContent = question.text;
      questionCounterEl.textContent = `Q${question.current}/${question.total}`;
      
      // Clear previous options
      optionsEl.innerHTML = '';
      
      // Add new options
      question.options.forEach((option, index) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg text-left transition-colors';
        optionBtn.textContent = option;
        optionBtn.onclick = () => submitAnswer(index);
        optionsEl.appendChild(optionBtn);
      });
      
      // Start timer
      startTimer(15);
    });

    socket.on('gameUpdate', (data) => {
      console.log('Game update:', data);
      updateRaceTrack(data.players);
      updateLeaderboard(data.players);
    });

    socket.on('showAnswer', (data) => {
      // Show correct answer
      answerFeedback.classList.remove('hidden');
      answerFeedback.className = 'mt-4 p-4 rounded-lg text-center bg-blue-600 text-white';
      answerFeedback.innerHTML = `<strong>Jawaban yang benar:</strong> ${data.correctText}`;
    });

    socket.on('answerFeedback', (data) => {
      console.log('Answer feedback:', data);
      
      // Show feedback
      answerFeedback.classList.remove('hidden');
      if (data.correct) {
        answerFeedback.className = 'mt-4 p-4 rounded-lg text-center bg-green-600 text-white';
        answerFeedback.innerHTML = '<strong>Benar! +10 poin</strong>';
      } else {
        answerFeedback.className = 'mt-4 p-4 rounded-lg text-center bg-red-600 text-white';
        answerFeedback.innerHTML = '<strong>Salah!</strong>';
      }
    });

    socket.on('timeUp', () => {
      console.log('Time up!');
      submitAnswer(-1);
    });

    socket.on('gameOver', (data) => {
      console.log('Game over:', data);
      
      gameScreenEl.classList.add('hidden');
      gameOverScreenEl.classList.remove('hidden');
      
      // Show winner
      winnerAnnouncement.innerHTML = `
        <h3 class="text-2xl font-bold text-yellow-400 mb-2">üèÜ Pemenang: ${data.winner.name}</h3>
        <p class="text-gray-300">Skor: ${data.winner.score} poin</p>
      `;
      
      // Show final scores
      finalScores.innerHTML = `
        <h4 class="text-lg font-bold text-white mb-3">Skor Akhir:</h4>
        <div class="space-y-2">
          ${data.scores.map((player, index) => `
            <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
              <span class="text-white">${index + 1}. ${player.name}</span>
              <span class="text-yellow-400 font-bold">${player.score} pts</span>
            </div>
          `).join('')}
        </div>
      `;
    });

    // Game Functions
    function submitAnswer(answerIndex) {
    if (hasAnswered) return;
    
    hasAnswered = true;
    clearInterval(timerInterval);
    
    document.querySelectorAll('#options button').forEach((btn, index) => {
        btn.disabled = true;
        btn.classList.add('opacity-50');
        if (index === answerIndex) {
        btn.classList.add('bg-blue-600');
        }
    });
    
    answerFeedback.classList.remove('hidden');
    answerFeedback.className = 'mt-4 p-4 rounded-lg text-center bg-blue-600 text-white';
    answerFeedback.innerHTML = '<strong>Mempersiapkan soal berikutnya...</strong>';
    
    if (answerIndex >= 0) {
        socket.emit('submitAnswer', {
        questionId: currentQuestion.id,
        answerIndex: answerIndex,
        questionStartTime: questionStartTime
        });
    }
    }
    function startTimer(seconds) {
      clearInterval(timerInterval);
      timeLeft = seconds;
      updateTimerBar();
      
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerBar();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!hasAnswered) {
            // Auto submit ketika waktu habis
            answerFeedback.classList.remove('hidden');
            answerFeedback.className = 'mt-4 p-4 rounded-lg text-center bg-gray-600 text-white';
            answerFeedback.innerHTML = '<strong>Waktu habis!</strong> Menunggu pertanyaan berikutnya...';
            
            document.querySelectorAll('#options button').forEach(btn => {
              btn.disabled = true;
              btn.classList.add('opacity-50');
            });
          }
        }
      }, 1000);
    }

    function updateTimerBar() {
      const percentage = (timeLeft / 15) * 100;
      timerBarEl.style.width = `${percentage}%`;
      timeLeftEl.textContent = `${timeLeft}s`;
      
      if (timeLeft <= 5) {
        timerBarEl.classList.add('animate-pulse');
        timerBarEl.classList.remove('bg-red-600');
        timerBarEl.classList.add('bg-yellow-500');
      } else {
        timerBarEl.classList.remove('animate-pulse');
        timerBarEl.classList.add('bg-red-600');
        timerBarEl.classList.remove('bg-yellow-500');
      }
    }

    function updateRaceTrack(players) {
      if (!players) return;
      
      playersTrackEl.innerHTML = '';
      
      Object.values(players).forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = `player-bike absolute top-1/2 transform -translate-y-1/2 w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xs border-2 border-white`;
        playerEl.style.backgroundColor = player.color;
        
        // Calculate position based on score (max possible score for positioning)
        const maxScore = Math.max(...Object.values(players).map(p => p.score), 1);
        const position = Math.min(90, (player.score / Math.max(maxScore, 500)) * 90);
        playerEl.style.left = `${position}%`;
        
        playerEl.title = `${player.name}: ${player.score} points`;
        playerEl.innerHTML = player.name.charAt(0).toUpperCase();
        playersTrackEl.appendChild(playerEl);
      });
    }

    function updateLeaderboard(players) {
      if (!players) return;
      
      const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);
      
      leaderboardListEl.innerHTML = sortedPlayers.map((player, index) => `
        <div class="flex items-center p-2 ${player.id === playerId ? 'bg-gray-700 rounded-lg' : ''}">
          <span class="w-6 text-center font-bold text-white">${index + 1}.</span>
          <div class="w-6 h-6 rounded-full mr-3 ml-2" style="background-color: ${player.color}"></div>
          <span class="flex-1 truncate text-white">${player.name}</span>
          <span class="w-16 text-right font-mono text-yellow-400">${player.score} pts</span>
        </div>
      `).join('');
    }

    socket.on('nextQuestionForPlayer', (data) => {
    // Update indeks soal saat ini
        gameState.currentQuestion = data.nextQuestionIndex;
        
        // Dapatkan soal berikutnya
        const nextQuestion = gameState.questions[data.nextQuestionIndex];
        
        // Update UI untuk soal baru
        hasAnswered = false;
        questionTextEl.textContent = nextQuestion.text;
        questionCounterEl.textContent = `Q${data.nextQuestionIndex + 1}/${data.totalQuestions}`;
        
        // Clear previous options
        optionsEl.innerHTML = '';
        
        // Add new options
        nextQuestion.options.forEach((option, index) => {
            const optionBtn = document.createElement('button');
            optionBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg text-left transition-colors';
            optionBtn.textContent = option;
            optionBtn.onclick = () => submitAnswer(index);
            optionsEl.appendChild(optionBtn);
        });
        
    // Start timer baru
    startTimer(15);
    });

    // Fungsi untuk generate PDF
    function generatePDF() {
    // Gunakan jsPDF dari window jika menggunakan versi umd
    const { jsPDF } = window.jspdf;
    
    // Buat elemen sementara untuk leaderboard
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    tempDiv.style.backgroundColor = '#1F2937'; // bg-gray-800
    tempDiv.style.padding = '20px';
    tempDiv.style.borderRadius = '12px';
    tempDiv.style.width = '400px';
    
    // Clone leaderboard content
    const leaderboardContent = document.getElementById('finalScores').cloneNode(true);
    const winnerContent = document.getElementById('winnerAnnouncement').cloneNode(true);
    
    // Tambahkan judul
    const title = document.createElement('h1');
    title.textContent = 'Hasil MotoGP Quiz Race';
    title.style.color = '#FFFFFF';
    title.style.fontSize = '24px';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '20px';
    title.style.textAlign = 'center';
    
    tempDiv.appendChild(title);
    tempDiv.appendChild(winnerContent);
    tempDiv.appendChild(leaderboardContent);
    
    document.body.appendChild(tempDiv);
    
    // Gunakan html2canvas untuk capture elemen
    html2canvas(tempDiv).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm'
        });
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('hasil.pdf');
        
        // Hapus elemen sementara
        document.body.removeChild(tempDiv);
    });
    }

    // Event listener untuk tombol download
    document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
  </script>
</body>
</html>